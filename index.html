<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f5f5f5;
      text-align: center;
    }
    input, select, button {
      font-size: 18px;
      margin: 10px;
      padding: 10px;
      width: 90%;
      max-width: 400px;
      box-sizing: border-box;
    }
    #sizesBox {
      margin-bottom: 20px;
    }
    #reader {
      margin: 10px auto;
      width: 300px;
      max-width: 98vw;
      display: none;
    }
    @media (max-width: 500px) {
      body {
        padding: 5px;
      }
      input, select, button {
        font-size: 16px;
        width: 98%;
        max-width: 98vw;
        margin: 6px 0;
      }
      h2 {
        font-size: 20px;
      }
      #reader {
        width: 98vw;
        min-width: 200px;
      }
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>ğŸ“¦ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
  <input type="text" id="productId" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬" autofocus>
  <button onclick="fetchSizes()">Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</button>
  <button onclick="startScan()">ğŸ“· Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
  <div id="reader"></div>

  <div id="sizesBox" style="display:none;">
    <select id="sizeSelect"></select><br>
    <button id="prepareBtn" onclick="prepareOrder()">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</button>
  </div>

  <p id="result"></p>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwK-ocQW5eO9n0_8qKy2o34dVjFT2Qyb2vE5HWVIoAU6KrwqwbcDiVT8dhmXOtGs3eEBw/exec'; 

    // ØªØ±ÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ ID Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      document.getElementById("productId").focus();
    };

    async function fetchSizes() {
      document.getElementById("result").textContent = "";
      document.getElementById("sizesBox").style.display = "none";
      const id = document.getElementById("productId").value.trim();
      if (!id) {
        document.getElementById("result").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬.";
        document.getElementById("productId").focus();
        return;
      }
      try {
        const res = await fetch(`${scriptURL}?action=getSizes&id=${id}`);
        const data = await res.json();

        if (data.success && data.sizes.length > 0) {
          const select = document.getElementById("sizeSelect");
          select.innerHTML = "";
          data.sizes.forEach(size => {
            const option = document.createElement("option");
            option.value = size;
            option.textContent = size;
            select.appendChild(option);
          });
          document.getElementById("sizesBox").style.display = "block";
        } else {
          document.getElementById("result").textContent = "âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª Ù…ØªØ§Ø­Ø©.";
          document.getElementById("productId").focus();
        }
      } catch (e) {
        document.getElementById("result").textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª.";
        document.getElementById("productId").focus();
      }
    }

    async function prepareOrder() {
      document.getElementById("result").textContent = "";
      const id = document.getElementById("productId").value.trim();
      const size = document.getElementById("sizeSelect").value;
      const btn = document.getElementById("prepareBtn");
      btn.disabled = true;

      try {
        const res = await fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify({ id, size, action: "prepareOrder" })
        });

        const result = await res.json();
        if (result.success) {
          document.getElementById("result").textContent = "âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.";
          document.getElementById("sizesBox").style.display = "none";
          document.getElementById("productId").value = "";
          document.getElementById("productId").focus();
        } else {
          document.getElementById("result").textContent = result.message || "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ².";
          document.getElementById("productId").focus();
        }
      } catch (e) {
        document.getElementById("result").textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨.";
        document.getElementById("productId").focus();
      }
      btn.disabled = false;
    }

    // Ø®Ø§ØµÙŠØ© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    let html5QrCode;
    function startScan() {
      document.getElementById("reader").style.display = "block";
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          scanBarcode();
        });
      } else {
        scanBarcode();
      }
    }

    function scanBarcode() {
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        (decodedText, decodedResult) => {
          document.getElementById("productId").value = decodedText;
          html5QrCode.stop().then(() => {
            html5QrCode.clear();
            document.getElementById("reader").style.display = "none";
            fetchSizes();
          });
        },
        (errorMessage) => {
          // ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù‡Ù†Ø§
        }
      ).catch(err => {
        alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
        document.getElementById("reader").style.display = "none";
      });
    }
  </script>
</body>
</html>
