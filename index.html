<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Cairo', Arial, sans-serif;
      padding: 0;
      margin: 0;
      background: linear-gradient(135deg, #f5f5f5 60%, #e0e7ff 100%);
      min-height: 100vh;
      text-align: center;
    }
    .container {
      background: #fff;
      margin: 30px auto;
      padding: 24px 18px 18px 18px;
      border-radius: 18px;
      box-shadow: 0 2px 16px #0001;
      max-width: 420px;
      width: 98vw;
    }
    h2 {
      margin-bottom: 24px;
      color: #3b3b3b;
      font-size: 2rem;
      letter-spacing: 1px;
    }
    .input-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    #productId {
      flex: 1;
      font-size: 18px;
      padding: 10px 12px;
      border: 1.5px solid #bdbdbd;
      border-radius: 8px;
      outline: none;
      transition: border 0.2s;
      background: #fafbff;
    }
    #productId:focus {
      border: 2px solid #6366f1;
      background: #f0f4ff;
    }
    .barcode-btn {
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .barcode-btn:hover, .barcode-btn:focus {
      background: #4f46e5;
    }
    button:not(.barcode-btn) {
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 0;
      font-size: 18px;
      margin: 8px 0;
      width: 100%;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 1px 4px #0001;
    }
    button:not(.barcode-btn):hover, button:not(.barcode-btn):focus {
      background: #4f46e5;
    }
    #sizesBox {
      margin-bottom: 20px;
    }
    select {
      font-size: 18px;
      padding: 10px;
      border-radius: 8px;
      border: 1.5px solid #bdbdbd;
      width: 100%;
      margin-bottom: 10px;
      background: #fafbff;
    }
    #result.success { color: #059669; font-weight: bold; }
    #result.error { color: #dc2626; font-weight: bold; }
    #reader {
      margin: 12px auto 0 auto;
      width: 320px;
      max-width: 98vw;
      display: none;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px #0002;
      background: #fff;
    }
    @media (max-width: 600px) {
      .container {
        margin: 8px auto;
        padding: 10px 2vw 14px 2vw;
        border-radius: 10px;
      }
      h2 {
        font-size: 1.2rem;
        margin-bottom: 14px;
      }
      .input-row {
        flex-direction: row;
        gap: 4px;
        margin-bottom: 10px;
      }
      #productId, select {
        font-size: 15px;
        padding: 8px 6px;
        border-radius: 6px;
      }
      .barcode-btn, button:not(.barcode-btn) {
        font-size: 17px;
        border-radius: 7px;
        height: 38px;
        min-width: 38px;
        padding: 0;
      }
      #reader {
        width: 98vw;
        min-width: 180px;
        border-radius: 8px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <h2>ğŸ“¦ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
<div id="modelsContainer">
  <div class="input-row">
    <input type="text" class="productId" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬" autocomplete="off">
    <button class="barcode-btn" onclick="startScan(this)" title="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" tabindex="0">ğŸ“·</button>
  </div>
</div>
    <button onclick="addModel()">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯ÙŠÙ„ Ø¢Ø®Ø±</button>
    <button onclick="fetchAllSizes()">Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</button>
    <button onclick="clearForm()">Ù…Ø³Ø­</button>
    <div id="reader"></div>

  <div id="sizesBox" style="display:none;">
  <div id="sizesCheckboxes"></div>
  <button id="prepareBtn" onclick="prepareOrder()">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨</button>
</div>

    <p id="result"></p>
  </div>
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwK-ocQW5eO9n0_8qKy2o34dVjFT2Qyb2vE5HWVIoAU6KrwqwbcDiVT8dhmXOtGs3eEBw/exec'; 

    // ØªØ±ÙƒÙŠØ² ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ ID Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    function focusProductId() {
  const input = document.querySelector(".productId");
  if (input) {
    input.focus();
    input.setSelectionRange(input.value.length, input.value.length);
  }
}
    window.onload = focusProductId;

function clearForm() {
  // Ø§Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„
  document.getElementById("modelsContainer").innerHTML = `
    <div class="input-row">
      <input type="text" class="productId" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬" autocomplete="off">
      <button class="barcode-btn" onclick="startScan(this)" title="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" tabindex="0">ğŸ“·</button>
    </div>
  `;
  document.getElementById("sizesBox").style.display = "none";
  document.getElementById("result").textContent = "";
  document.getElementById("result").className = "";
  focusProductId();
}

    async function fetchSizes() {
      document.getElementById("result").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      document.getElementById("result").className = "";
      document.getElementById("sizesBox").style.display = "none";
      const id = document.getElementById("productId").value.trim();
      if (!id) {
        document.getElementById("result").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬.";
        document.getElementById("result").className = "error";
        focusProductId();
        return;
      }
      try {
        const res = await fetch(`${scriptURL}?action=getSizes&id=${id}`);
        const data = await res.json();

        if (data.success && data.sizes.length > 0) {
  const sizesDiv = document.getElementById("sizesCheckboxes");
  sizesDiv.innerHTML = "";
  data.sizes.forEach(size => {
    const label = document.createElement("label");
    label.style.marginLeft = "12px";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = size;
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(" " + size));
    sizesDiv.appendChild(label);
  });
  document.getElementById("sizesBox").style.display = "block";
  document.getElementById("result").textContent = "";
  document.getElementById("result").className = "";
        } else {
          document.getElementById("result").textContent = "âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª Ù…ØªØ§Ø­Ø©.";
          document.getElementById("result").className = "error";
          focusProductId();
        }
      } catch (e) {
        document.getElementById("result").textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª.";
        document.getElementById("result").className = "error";
        focusProductId();
      }
    }
async function fetchAllSizes() {
  document.getElementById("result").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  document.getElementById("result").className = "";
  document.getElementById("sizesBox").style.display = "none";
  const ids = Array.from(document.querySelectorAll(".productId"))
    .map(input => input.value.trim())
    .filter(val => val);

  if (ids.length === 0) {
    document.getElementById("result").textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
    document.getElementById("result").className = "error";
    return;
  }

  let allSizes = [];
  for (const id of ids) {
    try {
      const res = await fetch(`${scriptURL}?action=getSizes&id=${id}`);
      const data = await res.json();
      if (data.success && data.sizes.length > 0) {
        allSizes.push({ id, sizes: data.sizes });
      } else {
        allSizes.push({ id, sizes: [], error: "âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª Ù…ØªØ§Ø­Ø©." });
      }
    } catch {
      allSizes.push({ id, sizes: [], error: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª." });
    }
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ù„ÙƒÙ„ Ù…ÙˆØ¯ÙŠÙ„
  const sizesDiv = document.getElementById("sizesCheckboxes");
  sizesDiv.innerHTML = "";
  allSizes.forEach(model => {
    const title = document.createElement("div");
    title.style.fontWeight = "bold";
    title.textContent = `Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${model.id}`;
    sizesDiv.appendChild(title);

    if (model.sizes.length > 0) {
      model.sizes.forEach(size => {
        const label = document.createElement("label");
        label.style.marginLeft = "12px";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = size;
        checkbox.dataset.modelId = model.id;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + size));
        sizesDiv.appendChild(label);
      });
    } else {
      const err = document.createElement("div");
      err.style.color = "red";
      err.textContent = model.error;
      sizesDiv.appendChild(err);
    }
    sizesDiv.appendChild(document.createElement("hr"));
  });

  document.getElementById("sizesBox").style.display = "block";
  document.getElementById("result").textContent = "";
  document.getElementById("result").className = "";
}

async function prepareOrder() {
  document.getElementById("result").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨...";
  document.getElementById("result").className = "";
  const btn = document.getElementById("prepareBtn");
  btn.disabled = true;

  // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  const checked = Array.from(document.querySelectorAll("#sizesCheckboxes input[type=checkbox]:checked"));
  const grouped = {};
  checked.forEach(cb => {
    const id = cb.dataset.modelId;
    if (!grouped[id]) grouped[id] = [];
    grouped[id].push(cb.value);
  });

  if (checked.length === 0) {
    document.getElementById("result").textContent = "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‚ÙŠØ§Ø³ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
    document.getElementById("result").className = "error";
    btn.disabled = false;
    return;
  }

  let allSuccess = true;
  let messages = [];
  for (const id in grouped) {
    for (const size of grouped[id]) {
      try {
        const res = await fetch(scriptURL, {
          method: 'POST',
          body: JSON.stringify({ id, size, action: "prepareOrder" })
        });
        const result = await res.json();
        if (!result.success) {
          allSuccess = false;
          messages.push(result.message || `ÙØ´Ù„ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${id} Ø§Ù„Ù‚ÙŠØ§Ø³ ${size}`);
        }
      } catch (e) {
        allSuccess = false;
        messages.push(`Ø®Ø·Ø£ ÙÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ ${id} Ø§Ù„Ù‚ÙŠØ§Ø³ ${size}`);
      }
    }
  }

  if (allSuccess) {
    document.getElementById("result").textContent = "âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.";
    document.getElementById("result").className = "success";
    document.getElementById("sizesBox").style.display = "none";
    document.getElementById("modelsContainer").innerHTML = `
      <div class="input-row">
        <input type="text" class="productId" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬" autocomplete="off">
        <button class="barcode-btn" onclick="startScan(this)" title="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" tabindex="0">ğŸ“·</button>
      </div>
    `;
  } else {
    document.getElementById("result").textContent = messages.join(" | ");
    document.getElementById("result").className = "error";
  }
  btn.disabled = false;
}
    let html5QrCode;
function startScan(btn) {
  document.getElementById("reader").style.display = "block";
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      html5QrCode.clear();
      scanBarcode(btn);
    });
  } else {
    scanBarcode(btn);
  }
}

function scanBarcode(btn) {
  html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: 250
    },
    (decodedText, decodedResult) => {
      // Ø­Ø¯Ø¯ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
      const input = btn ? btn.parentElement.querySelector(".productId") : document.querySelector(".productId");
      if (input) input.value = decodedText;
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        document.getElementById("reader").style.display = "none";
        focusProductId();
      });
    },
    (errorMessage) => {
      // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
    }
  ).catch(err => {
    alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err);
    document.getElementById("reader").style.display = "none";
  });
}
  document.addEventListener("keydown", function(e) {
  // ØªØ¬Ù‡ÙŠØ² Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ø¥Ø°Ø§ ÙƒØ§Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø¸Ø§Ù‡Ø±
  if (e.key === "Enter" && document.getElementById("sizesBox").style.display === "block") {
    prepareOrder();
  }
});
function addModel() {
  const container = document.getElementById("modelsContainer");
  const div = document.createElement("div");
  div.className = "input-row";
  div.innerHTML = `
    <input type="text" class="productId" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù…Ù†ØªØ¬" autocomplete="off">
    <button class="barcode-btn" onclick="startScan(this)" title="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" tabindex="0">ğŸ“·</button>
  `;
  container.appendChild(div);
}
  </script>
</body>
</html>
